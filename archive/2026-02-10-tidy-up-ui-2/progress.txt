## Codebase Patterns
- Use `CGO_ENABLED=0` for all Go build/vet commands (required for modernc.org/sqlite)
- Go binary is at `/home/node/go/bin/go` - use `export PATH="$PATH:/home/node/go/bin"` before Go commands
- Database connection uses modernc.org/sqlite (pure Go implementation, no CGO)
- Add new table migrations to the `migrate()` function in db/db.go - always use `CREATE TABLE IF NOT EXISTS`
- Bubble Tea key strings: use "esc" (not "escape"), "enter", "tab", "backspace", "left", "right" for key handling
- SQL queries live in `db/sql/*.sql` files, embedded via `go:embed` in `db/queries.go` ‚Äî reference as `db.InsertNoteSQL` etc.
- go:embed can only access files within the same package directory or subdirectories (no `../` paths)
- Three-column TUI layout uses padToWidth helper + manual row-by-row assembly (split lines, pad, join with border chars)
- lipgloss.Width() accounts for ANSI escape sequences when measuring rendered string width
- Column 3 live stats use loadTackleStatsForPanel() on tick ‚Äî only updates when stats view is not active to avoid conflicts
- Go structs for all tables in db/models.go; database functions (insert/select/delete) in db/functions.go
- Use `db.InsertNoteWithChildren(database, category, db.NoteChildren{...})` for transactional insert of note + child records
- CLI commands create notes with category field ("clip", "tackle", or user-provided) plus child rows for timing, video, and type-specific data
- TUI note/tackle/clip creation also uses `db.InsertNoteWithChildren()` ‚Äî same pattern as CLI commands
- Tackle stats in TUI use inline SQL queries joining note_tackles, notes, note_videos, and note_highlights (not embedded SQL files)
- loadNotesAndTackles() uses inline SQL joining notes, note_videos, note_timing, then loads child details/tackles/highlights per note
- Star highlights are stored as note_highlights rows with type="star", not as a column on notes
- huh forms package lives in tui/forms/ ‚Äî theme, note form, and tackle form go here
- huh form integration pattern: store *huh.Form + result struct in Model, delegate Update/View, check State for completion
- huh forms need ALL message types delegated (not just KeyMsg) ‚Äî cursor blink, focus msgs are internal
- huh Select auto-sets value to first option on Init() ‚Äî exclude from HasData() checks for "empty form" detection
- Confirm discard pattern: intercept StateAborted, check HasData(), show confirm form, reopen original form if user cancels
- Normal-mode keybindings in Update() switch: msg.String() returns "left", "right", "up", "down" for arrow keys and "," "." for punctuation
- Command mode already handles "left"/"right" for cursor movement ‚Äî normal-mode arrow cases only fire when commandInput.Active is false
- Column 1 renderColumn1() now uses GetControlGroups() from controls.go (single source of truth) ‚Äî ControlGroup uses SubGroups [][]Control for divider placement
- padToWidth() uses lipgloss.Width() to ANSI-aware pad AND truncate lines to exact column width
- truncateToWidth() preserves ANSI escape sequences while trimming visible width
- normalizeLines() ensures column line arrays are exactly the target height
- Responsive layout: col3HideThreshold=90, col3MinWidth=18; at <90 cols, two-column layout with single border
- Arrow keys ("left","right","up","down") and punctuation (",",".") added as alternatives in normal-mode switch
- Use `ansi.Truncate()` from `charmbracelet/x/ansi` for ANSI+grapheme-aware truncation (handles emoji/wide chars)
- Shared time formatting lives in `pkg/timeutil/timeutil.go` ‚Äî use `timeutil.FormatTime(seconds)` everywhere instead of inline formatting
- Shared time parsing lives in `pkg/timeutil/timeutil.go` ‚Äî use `timeutil.ParseTimeToSeconds(str)` for HH:MM:SS, MM:SS, or raw seconds
- Bordered control boxes: use `components.RenderControlBox(group, width)` ‚Äî renders tab header + box-drawing border + horizontal dividers between sub-groups
- db package cannot import tui/forms (circular dependency) ‚Äî use db-package structs for return types, let TUI caller map to form result types
- Edit tackle form: `forms.NewEditTackleForm(timestamp, endSeconds, result)` with `EditTackleFormResult` struct; load data with `db.LoadNoteForEdit(db, noteID)` returning `db.EditTackleData`
- Edit flow uses `editingNoteID` field (0=create, >0=edit) to distinguish save paths; separate `editTackleFormResult` avoids state mixing with create flow
- When reopening edit form after cancel, save/restore Timestamp and EndSeconds strings around `NewEditTackleForm()` constructor call
- Mini player: `components.RenderMiniPlayer(statusBar, width)` renders compact bordered card for narrow terminals (< minTerminalWidth)

---

## 2026-02-10 - US-071
- Updated `formatTimeString()` in tui/tui.go from `%d:%02d` (M:SS) to `%d:%02d:%02d` (H:MM:SS)
- Updated `formatTime()` in tui/components/statusbar.go from `%02d:%02d` (MM:SS) to `%d:%02d:%02d` (H:MM:SS)
- Both functions now produce identical output for the same input
- Files changed: tui/tui.go, tui/components/statusbar.go
- **Learnings for future iterations:**
  - Both formatTimeString (tui.go) and formatTime (statusbar.go) had slightly different format strings (%d vs %02d for minutes) ‚Äî now unified to `%d:%02d:%02d`
  - The hour component uses `totalSeconds / 3600`, minutes use `(totalSeconds % 3600) / 60`
---

## 2026-02-10 - US-072
- Created `pkg/timeutil/timeutil.go` with shared `FormatTime(seconds float64) string` function
- Replaced all inline `int(x)/60`, `int(x)%60`, `%d:%02d` patterns in CLI commands with `timeutil.FormatTime()`
- Updated `cmd/note.go` (noteAddCmd, noteListCmd, noteGotoCmd), `cmd/clip.go` (clipStartCmd, clipEndCmd, clipListCmd, clipPlayCmd), `cmd/tackle.go` (tackleAddCmd, tackleListCmd), `cmd/root.go` (openCmd duration display)
- Replaced `formatTimeString()` in tui/tui.go and `formatTime()` in tui/components/statusbar.go with `timeutil.FormatTime()`
- Also updated tui/components/timeline.go and tui/components/noteslist.go to use the shared function
- Files changed: pkg/timeutil/timeutil.go (new), cmd/note.go, cmd/clip.go, cmd/root.go, cmd/tackle.go, tui/tui.go, tui/components/statusbar.go, tui/components/timeline.go, tui/components/noteslist.go
- **Learnings for future iterations:**
  - The `formatTime` function was also used in timeline.go and noteslist.go (same components package) ‚Äî check all usages within a package before removing a function
  - Using `replace_all` in Edit tool also replaces function definitions, not just calls ‚Äî be careful with broad replacements
  - cmd/root.go also had inline time formatting (duration display in open command) ‚Äî search broadly for patterns like `int(x)/60`
---

## 2026-02-10 - US-073
- Replaced inline MM:SS formatting in tackleform.go and noteform.go with `timeutil.FormatTime()`
- Both form headers now show H:MM:SS format (e.g. "Add Tackle @ 0:05:30", "Add Note @ 0:05:30")
- Increased notes list time column width from 8 to 9 chars to accommodate H:MM:SS format
- noteslist.go already used `timeutil.FormatTime()` from US-072, no change needed there
- Files changed: tui/forms/tackleform.go, tui/forms/noteform.go, tui/components/noteslist.go
- **Learnings for future iterations:**
  - The forms package had its own inline time formatting separate from the components package ‚Äî always search for `int(timestamp)`, `/ 60`, `% 60` patterns across all packages
  - noteslist.go time column was 8 chars wide which could truncate H:MM:SS for videos >= 10 hours ‚Äî bumped to 9
---

## 2026-02-10 - US-074
- Added `ParseTimeToSeconds()` to `pkg/timeutil/timeutil.go` with colon-count based parsing: 2 colons = H:M:S, 1 colon = M:S, 0 colons = raw seconds
- Replaced local `parseTimeToSeconds()` in `tui/tui.go` with `timeutil.ParseTimeToSeconds()`
- Removed unused local `parseTimeToSeconds()` from `cmd/note.go` (was defined but never called)
- Updated seek error message to mention HH:MM:SS format
- Files changed: pkg/timeutil/timeutil.go, tui/tui.go, cmd/note.go
- **Learnings for future iterations:**
  - The `parseTimeToSeconds()` in cmd/note.go was dead code ‚Äî never called anywhere. Always check for actual call sites before assuming a function is in use
  - `strings.Count(timeStr, ":")` is a clean way to dispatch on time format rather than trying to parse each format sequentially
  - Consolidating parse + format in the same `pkg/timeutil` package keeps all time handling in one place
---

## 2026-02-10 - US-075
- Restructured `ControlGroup` to use `SubGroups [][]Control` instead of flat `Controls []Control`
- Removed `Emoji` field from `Control` struct ‚Äî no longer used anywhere
- Reorganized into 3 groups: Playback (3 sub-groups: Play/Back/Fwd, Step-/Step+, Frame-/Frame+), Navigation (Prev/Next/Mute/Overlay), Views (Stats/Help/Quit)
- Updated `ControlsDisplay()` horizontal bar to iterate sub-groups, format as `Name [Shortcut]` without emojis
- Updated `renderColumn1()` in tui.go to iterate sub-groups with blank line separators between sub-groups
- Files changed: tui/components/controls.go, tui/tui.go
- **Learnings for future iterations:**
  - The old 4-group structure (Playback, Navigation, Step/Overlay, Views) merged into 3 groups ‚Äî Step controls moved into Playback as sub-group, Overlay moved to Navigation
  - `ControlsDisplay()` is used as a horizontal bar during forms ‚Äî it also needed updating to iterate `SubGroups` instead of `Controls`
  - `renderColumn1()` directly iterated `group.Controls` ‚Äî needed refactoring to use nested sub-group iteration
---

## 2026-02-10 - US-076
- Added `RenderControlBox(group ControlGroup, width int) string` to tui/components/controls.go
- Renders bordered box with tab-style header using box-drawing characters (‚îå‚îê‚îî‚îò‚îÇ‚îÄ‚îú‚î§)
- Tab header spans 3 lines: tab top, tab bracket with styled name, tab bottom extending to full width
- Horizontal dividers (‚îú‚îÄ‚îÄ‚îÄ‚î§) separate sub-groups within the box
- Control rows: name left-aligned, [ Shortcut ] right-aligned with proper padding
- Colors: borders=Purple, header=Pink, names=LightLavender, shortcuts=Cyan
- Uses ansi.Truncate() for safe width truncation
- Files changed: tui/components/controls.go
- **Learnings for future iterations:**
  - The tab header design requires 3 lines: the tab top (offset by 1 space), the bracket line (‚îå‚î§ Name ‚îú‚îê), and the connecting line (‚îÇ‚îî‚îÄ‚îò‚îî‚îÄ‚îÄ‚îÄ‚îê) that ties the tab to the full-width box
  - Inner width = total width - 2 (for left and right border chars)
  - For the connecting line (line 3), remainW = innerW - tabInnerW - 3 accounts for the ‚îî, ‚îò, and ‚îî characters between tab bottom and right extension
  - `lipgloss.Width()` is essential for measuring strings with ANSI escape codes when calculating padding
---

## 2026-02-10 - US-078
- Added `UpdateNoteWithChildren(db, noteID, children)` function to `db/functions.go` ‚Äî deletes existing child rows (details, zones, highlights, tackles) and re-inserts from NoteChildren struct, all in a transaction
- Added `UpdateNoteTiming(db, noteID, start, end)` function to `db/functions.go` ‚Äî updates the timing record for a given note, returns `sql.ErrNoRows` if no timing row exists
- Created SQL files: `delete_note_details.sql`, `delete_note_zones.sql`, `delete_note_highlights.sql`, `delete_note_tackles.sql`, `update_note_timing.sql`
- Added `go:embed` vars in `db/queries.go` for all new SQL files
- Files changed: db/functions.go, db/queries.go, db/sql/delete_note_details.sql (new), db/sql/delete_note_zones.sql (new), db/sql/delete_note_highlights.sql (new), db/sql/delete_note_tackles.sql (new), db/sql/update_note_timing.sql (new)
- **Learnings for future iterations:**
  - The delete-then-reinsert pattern is simpler than individual UPDATE statements for child tables since there can be varying numbers of child rows
  - `UpdateNoteTiming` uses positional args `(start, end, noteID)` matching the SQL `SET start=?, end=? WHERE note_id=?` ‚Äî parameter order differs from InsertNoteTiming
  - The child tables all have ON DELETE CASCADE from notes, but for updating children without deleting the parent note, explicit DELETE per child table is needed
---

## 2026-02-10 - US-077
- Replaced flat controls list in renderColumn1() with bordered container boxes using RenderControlBox()
- Each of the 3 control groups (Playback, Navigation, Views) now renders as a bordered box with tab header
- Playback box shows 3 sub-groups separated by horizontal dividers matching wireframe/playback.txt
- Navigation and Views boxes show single sub-groups without internal dividers
- 1 blank line gap separates each bordered container
- Playback status card and Selected Tag detail card remain unchanged above controls
- ControlsDisplay() horizontal bar already correctly uses Name [Shortcut] format with no emojis (from US-075)
- Files changed: tui/tui.go
- **Learnings for future iterations:**
  - The RenderControlBox() function from US-076 made this change very simple ‚Äî just iterate groups and call it
  - The old renderColumn1() had ~30 lines of manual control rendering that collapsed to ~6 lines
  - No import changes needed since all the removed local styles (subHeaderStyle, shortcutStyle, nameStyle) were local variables, and their underlying packages (lipgloss, styles) were still used elsewhere in the function
---

## 2026-02-10 - US-079
- Added `x` / `X` keybinding in normal mode to delete the selected item from the notes list
- New `deleteSelectedItem()` method calls `db.DeleteNote()` (cascade handles all child tables)
- After deletion: reloads notes list via `loadNotesAndTackles()`, refreshes stats via `loadTackleStatsForPanel()`
- Shows confirmation message in command bar (e.g. "Deleted tackle 42")
- Graceful index reset: if list becomes empty sets index to 0, if index exceeds items length adjusts to last item
- Help overlay updated with `X - Delete selected item` in Navigation group
- Files changed: tui/tui.go, tui/components/help.go
- **Learnings for future iterations:**
  - `db.DeleteNote()` already exists with cascade delete ‚Äî no new SQL needed for deletion
  - `loadNotesAndTackles()` resets SelectedIndex to 0, so the manual adjustment handles cases where the last item was deleted
  - The help overlay is in `tui/components/help.go` with inline struct definitions for groups and bindings
---

## 2026-02-10 - US-080
- Added `EditTackleFormResult` struct extending `TackleFormResult` with `Timestamp` and `EndSeconds` string fields
- Added `NewEditTackleForm(timestamp, endSeconds, result)` to `tui/forms/tackleform.go` ‚Äî creates a pre-filled form with "Edit Tackle @ H:MM:SS" header, editable timestamp/end seconds fields, and all existing tackle fields
- Timestamp field validates via `timeutil.ParseTimeToSeconds()`, end seconds validates as positive float
- Added `EditTackleData` struct and `LoadNoteForEdit(db, noteID)` to `db/functions.go` ‚Äî queries note_tackles, note_timing, note_details, note_zones, note_highlights and returns all data needed for the edit form
- End seconds calculated as `timing.End - timing.Start`, falls back to 2.0 if difference is <= 0
- Used `db.EditTackleData` instead of `forms.TackleFormResult` as return type to avoid circular dependency (db -> tui/forms)
- Files changed: tui/forms/tackleform.go, db/functions.go
- **Learnings for future iterations:**
  - Cannot return `forms.TackleFormResult` from `db/functions.go` ‚Äî that would create a circular dependency (db imports tui/forms which imports db). Use a db-package struct and let the caller map it
  - `EditTackleFormResult` embeds `TackleFormResult` ‚Äî the TUI caller will need to pre-fill the embedded fields from `EditTackleData` before passing to `NewEditTackleForm()`
  - The form stores Timestamp and EndSeconds as strings (for huh input binding) ‚Äî caller must convert float64 <-> string
  - `%g` format for float64->string avoids trailing zeros (e.g. "2" instead of "2.000000")
---

## 2026-02-10 - US-081
- Added `editingNoteID` field to Model (0 = create mode, >0 = edit mode) and `editTackleFormResult` for edit form binding
- Wired up `e`/`E` keybinding in normal mode to open edit tackle form via `openEditTackleInput()`
- `openEditTackleInput()` checks item type (only tackles), calls `db.LoadNoteForEdit()`, maps `db.EditTackleData` to `forms.EditTackleFormResult`, opens `NewEditTackleForm()`
- `saveEditTackleFromForm()` parses timestamp/endSeconds from form, calls `db.UpdateNoteWithChildren()` and `db.UpdateNoteTiming()`, reloads list and stats
- Updated `handleTackleFormUpdate()` to route to `saveEditTackleFromForm()` when `editingNoteID > 0`
- Updated confirm-discard flow: discard resets `editingNoteID`, go-back uses `reopenTackleForm()` helper that preserves user-edited timestamp/endSeconds values
- Pressing `e` on a non-tackle item shows "Edit not supported for notes" message
- Help overlay updated with `E - Edit selected tackle` in Navigation group
- Files changed: tui/tui.go, tui/components/help.go
- **Learnings for future iterations:**
  - `NewEditTackleForm()` overwrites `result.Timestamp` and `result.EndSeconds` ‚Äî when reopening after cancel, save/restore these values around the constructor call
  - The `editTackleFormResult` is separate from `tackleFormResult` to avoid state mixing between create and edit flows
  - `HasData()` on an edit form always returns true (pre-populated) ‚Äî the confirm discard dialog will always show on Esc during edit, which is the correct behavior
  - Import `strconv` was needed for `ParseFloat` on endSeconds
---

## 2026-02-10 - US-082
- Added `RenderMiniPlayer(state StatusBarState, termWidth int) string` to `tui/components/controls.go` ‚Äî renders a compact bordered card with tab header matching wireframe/mini-player.txt
- Card shows play/pause state + step size on first line, horizontal divider, time position / duration on second line
- Mute icon (üîá) appended to status line when muted
- Card is horizontally centered when terminal width exceeds card width
- Warning line "Mini player mode - resize for full view" in Lavender italic below the card
- Replaced "Terminal too narrow" warning in View() with `components.RenderMiniPlayer()` call
- Added `timeutil` import to controls.go for `FormatTime()`
- Files changed: tui/components/controls.go, tui/tui.go
- **Learnings for future iterations:**
  - The mini player reuses the same box-drawing pattern as `RenderControlBox` (tab header 3 lines, content rows, dividers) ‚Äî could potentially extract a shared "bordered card" builder but keeping them separate is simpler for now
  - Card width is dynamically computed from content width (widest of status line and time line + 4 for borders/padding), not from terminal width
  - `formatStepSize()` exists in both statusbar.go and tui.go (duplicate) ‚Äî controls.go can access the one in statusbar.go since they're in the same package
  - The tick loop continues running in mini player mode so playback state (play/pause, time position) stays updated live
---

## 2026-02-10 - US-083
- Added early key filter in `tea.KeyMsg` handler: when `m.width > 0 && m.width < minTerminalWidth`, only playback-related keys pass through
- Allowed keys: space (play/pause), h/H/left (seek back), l/L/right (seek fwd), comma/< (step-), period/> (step+), m/M (mute), ctrl+h (frame back), ctrl+l (frame fwd), ctrl+c (quit), ? (help)
- All other keys (t, n, e, x, j, k, enter, colon, s, o, etc.) suppressed in mini player mode
- Filter placed after help overlay handler (so help can still be dismissed) but before stats/form/command mode handlers
- State preserved automatically: WindowSizeMsg only updates width/height, tick loop runs unconditionally
- Files changed: tui/tui.go
- **Learnings for future iterations:**
  - Go switch with empty case body (`case ...: // fall through`) is the idiomatic way to whitelist specific values and suppress the rest via `default`
  - The key filter must come after the help overlay handler so pressing any key while help is shown still dismisses it
  - No state reset needed for mini/full transitions ‚Äî the Model persists all state, only the View changes
---

