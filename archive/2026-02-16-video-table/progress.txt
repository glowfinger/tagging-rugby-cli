## Codebase Patterns
- Use `CGO_ENABLED=0` for all Go build/vet commands (required for modernc.org/sqlite)
- Go binary is at `/home/node/go/bin/go` - use `export PATH="$PATH:/home/node/go/bin"` before Go commands
- Database connection uses modernc.org/sqlite (pure Go implementation, no CGO)
- SQL queries live in `db/sql/*.sql` files, embedded via `go:embed` in `db/queries.go`
- db package cannot import tui/forms (circular dependency) — use db-package structs, let TUI map to form types
- InsertNote and InsertNoteWithChildren now require videoID int64 parameter (replaces NoteChildren.Videos)
- NoteVideo struct removed — use Video struct + note.VideoID instead
- SelectNotes/SelectNoteByID now scan video_id field from notes table
- EnsureVideo(db, path) is the standard get-or-create pattern for video records
- Inline SQL queries use `INNER JOIN videos v ON v.id = n.video_id WHERE v.path = ?` (not note_videos)

---

## 2026-02-16 - US-001
- Created `videos` table in create_tables.sql with columns: id, path, filename, extension, format, filesize, stop_time
- Added `video_id INTEGER NOT NULL REFERENCES videos(id)` to notes table
- Removed `note_videos` CREATE TABLE statement from create_tables.sql
- Added `Video` struct to db/models.go with matching fields
- Added `VideoID int64` field to `Note` struct
- Kept `NoteVideo` struct as deprecated for build compatibility (callers still reference it)
- Files changed: db/sql/create_tables.sql, db/models.go
- **Learnings for future iterations:**
  - Cannot remove NoteVideo struct until callers are updated (US-003/US-004) — keep it deprecated
  - videos table must be created BEFORE notes table (notes references videos via FK)
---

## 2026-02-16 - US-002
- Created 4 new SQL files: insert_video.sql, select_video_by_id.sql, select_video_by_path.sql, update_video_stop_time.sql
- Added go:embed directives for all new SQL files in db/queries.go
- Added 4 new Go functions: InsertVideo, SelectVideoByID, SelectVideoByPath, UpdateVideoStopTime in db/functions.go
- Kept old insert_note_video.sql and select_note_videos_by_note.sql (marked deprecated) — still referenced by Go functions
- Files changed: db/queries.go, db/functions.go, db/sql/insert_video.sql, db/sql/select_video_by_id.sql, db/sql/select_video_by_path.sql, db/sql/update_video_stop_time.sql
- **Learnings for future iterations:**
  - Cannot remove old SQL files until the Go functions referencing them are also removed (US-003)
  - Video CRUD functions follow same pattern as note child table functions (QueryRow for single, Exec for insert/update)
  - UpdateVideoStopTime uses RowsAffected check + sql.ErrNoRows, matching UpdateNoteTiming pattern
---

## 2026-02-16 - US-003
- Updated insert_note.sql to accept video_id: `INSERT INTO notes (category, video_id) VALUES (?, ?)`
- Updated select_notes.sql and select_note_by_id.sql to include video_id in SELECT columns
- Rewrote select_notes_with_video.sql to JOIN notes → videos via notes.video_id (no note_videos)
- Updated InsertNote signature: now accepts `(db, category, videoID)` instead of `(db, category)`
- Updated InsertNoteWithChildren signature: now accepts `(db, category, videoID, children)` — videoID is set on the note directly
- Removed Videos field from NoteChildren struct
- Removed InsertNoteVideo and SelectNoteVideosByNote functions from db/functions.go
- Removed NoteVideo struct from db/models.go
- Deleted insert_note_video.sql and select_note_videos_by_note.sql
- Removed go:embed directives for deleted SQL files from db/queries.go
- Updated all callers (cmd/clip.go, cmd/note.go, cmd/tackle.go, tui/tui.go) to use new signatures with videoID=0 placeholder
- Replaced SelectNoteVideosByNote call in cmd/clip.go (export) with SelectNoteByID + SelectVideoByID
- Removed unused variables (duration, videoPath) from callers that no longer create NoteVideo records
- Files changed: db/functions.go, db/models.go, db/queries.go, db/sql/insert_note.sql, db/sql/select_notes.sql, db/sql/select_note_by_id.sql, db/sql/select_notes_with_video.sql, cmd/clip.go, cmd/note.go, cmd/tackle.go, tui/tui.go
- Deleted: db/sql/insert_note_video.sql, db/sql/select_note_videos_by_note.sql
- **Learnings for future iterations:**
  - When removing a struct field used by callers, all callers must be updated in the same commit for build to pass
  - Callers currently pass videoID=0 — US-004 must wire up real video lookup (InsertVideo/SelectVideoByPath) before runtime works
  - Inline SQL queries in tui/tui.go and cmd/*.go still reference note_videos table — US-004 must update these
  - cmd/clip.go export command now uses SelectNoteByID + SelectVideoByID chain instead of SelectNoteVideosByNote
---

## 2026-02-16 - US-004
- Added `EnsureVideo(db, path)` helper to db/functions.go — get-or-create pattern using SelectVideoByPath + InsertVideo
- Added `videoID int64` field to TUI Model, set once in `Run()` via EnsureVideo
- Updated all 8 inline SQL queries across 5 files to JOIN `videos v ON v.id = n.video_id` instead of `note_videos nv ON nv.note_id = n.id`
- Replaced all 9 `InsertNoteWithChildren(..., 0, ...)` calls with real video IDs:
  - TUI callers use `m.videoID` (set at startup)
  - CLI callers (cmd/note.go, cmd/tackle.go, cmd/clip.go) call `db.EnsureVideo(database, videoPath)` before insert
- Added video path retrieval from mpv in cmd/note.go noteAddCmd and cmd/tackle.go tackleAddCmd (previously missing)
- Files changed: db/functions.go, tui/tui.go, cmd/root.go, cmd/note.go, cmd/clip.go, cmd/tackle.go
- **Learnings for future iterations:**
  - EnsureVideo is the canonical way to get a video ID from a path — use it in any new command that creates notes
  - TUI stores videoID once at startup since the video path doesn't change during a session
  - CLI commands must get video path from mpv via `client.GetProperty("path")` before calling EnsureVideo
  - When renaming a function parameter (db → database), check for `:=` vs `=` on existing variables in the same scope
---
