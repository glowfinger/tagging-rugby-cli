## Codebase Patterns
- Use `CGO_ENABLED=0` for all Go build/vet commands (required for modernc.org/sqlite)
- Go binary is at `/home/node/go/bin/go` - use `export PATH="$PATH:/home/node/go/bin"` before Go commands
- Database connection uses modernc.org/sqlite (pure Go implementation, no CGO)
- Add new table migrations to the `migrate()` function in db/db.go - always use `CREATE TABLE IF NOT EXISTS`

---

## 2026-01-26 - US-001
- Initial project scaffolding with cobra CLI framework
- Created main.go and cmd/root.go with root and version commands
- Files changed: main.go, cmd/root.go, go.mod, go.sum
- **Learnings for future iterations:**
  - Typecheck with CGO_ENABLED=0 to avoid CGO issues
  - cobra CLI structure: main.go calls cmd.Execute(), cmd/root.go defines rootCmd

---

## 2026-01-26 - US-002
- What was implemented: SQLite database setup with Open function
- Files changed: db/db.go, go.mod, go.sum
- **Learnings for future iterations:**
  - Database file stored at ~/.local/share/tagging-rugby-cli/data.db
  - Uses modernc.org/sqlite for pure Go SQLite (no CGO required)
  - db.Open() creates parent directories automatically
  - Always verify connection with db.Ping() before returning

---

## 2026-01-26 - US-003
- What was implemented: Notes table migration with idempotent CREATE TABLE IF NOT EXISTS
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Migrations run automatically via migrate() helper in db.Open()
  - Add future table migrations to the migrate() function
  - Each table creation should use CREATE TABLE IF NOT EXISTS for idempotency

---

## 2026-01-26 - US-004
- What was implemented: Clips table migration for storing video segments
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Follow same pattern as notes table: add to migrate() function with CREATE TABLE IF NOT EXISTS
  - Clips table stores start_seconds and end_seconds (REAL) to define video segments

---

## 2026-01-26 - US-005
- What was implemented: Categories table migration with default category seeding
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Use `INSERT OR IGNORE INTO` for idempotent seeding of default values
  - Default categories: try, tackle, turnover, lineout, scrum, penalty, kick
  - Categories table has UNIQUE constraint on name column

---

## 2026-01-26 - US-006
- What was implemented: Tackles table migration for detailed tackle tracking
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Use SQLite CHECK constraint for enum-like fields: `outcome TEXT CHECK(outcome IN ('missed', 'completed', 'possible', 'other'))`
  - Star field is INTEGER (0/1) since SQLite has no native boolean type

---

## 2026-01-26 - US-007
- What was implemented: mpv IPC client with Unix socket connection
- Files changed: mpv/client.go (new file)
- **Learnings for future iterations:**
  - mpv package provides Client struct with Connect() and Close() methods
  - Default socket path: /tmp/tagging-rugby-mpv.sock (defined as DefaultSocketPath constant)
  - Use sync.Mutex for thread-safe connection handling
  - Custom errors: ErrNotConnected, ErrSocketNotFound for clear error handling

---

## 2026-01-26 - US-008
- What was implemented: sendCommand method for mpv IPC JSON protocol
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - mpv IPC uses JSON with format: `{"command": [cmd, args...], "request_id": <id>}`
  - Responses include `data`, `error`, and `request_id` fields
  - Use request_id to match responses since mpv can send async events
  - Use bufio.Reader for efficient line-based reading (responses are newline-terminated)
  - Error field is "success" on success, otherwise contains error message
  - Use sync/atomic for thread-safe request ID generation

---

## 2026-01-26 - US-009
- What was implemented: Get/set property methods for mpv IPC client
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - Use `get_property` and `set_property` mpv commands for property access
  - mpv property names use hyphens (e.g., "time-pos", "ab-loop-a")
  - JSON unmarshals numbers as float64 - use helper function to handle type conversions
  - Boolean properties (like "pause") return Go bool type directly from JSON
  - Convenience methods (GetTimePos, GetDuration, GetPaused) wrap GetProperty for type safety

---

## 2026-01-26 - US-010
- What was implemented: Playback control methods for mpv IPC client
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - Use `seek` command with "absolute" or "relative" as second argument for seeking
  - Play/Pause simply set the "pause" property to false/true
  - TogglePause reads current state then inverts it
  - mpv seek command: `{"command": ["seek", <seconds>, "<mode>"]}`

---

## 2026-01-26 - US-011
- What was implemented: Advanced playback controls - speed, frame stepping, and mute
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - mpv `speed` property accepts float multipliers (1.0 = normal, 0.5 = half, 2.0 = double)
  - `frame-step` and `frame-back-step` are mpv commands (not properties) for single frame navigation
  - `mute` property is a boolean for audio muting
  - Boolean properties (pause, mute) return Go bool directly from JSON unmarshal

---

## 2026-01-26 - US-012
- What was implemented: A-B loop controls for clip playback
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - A-B loop uses `ab-loop-a` and `ab-loop-b` properties (hyphens, not underscores)
  - To clear the loop, set both properties to the string "no" (not a boolean or nil)
  - SetProperty accepts any interface{} so strings and floats both work

---

## 2026-01-26 - US-013
- What was implemented: Dependency checker with doctor command
- Files changed: deps/deps.go (new), cmd/root.go
- **Learnings for future iterations:**
  - Use `exec.LookPath` to check if a binary is available in PATH
  - deps package provides CheckMpv, CheckFfmpeg, and CheckAll functions
  - DependencyError type includes name and install URL for user-friendly messages
  - Doctor command exits with code 1 if any dependency is missing

---

## 2026-01-26 - US-014
- What was implemented: LaunchMpv function to start mpv with IPC socket
- Files changed: mpv/launch.go (new)
- **Learnings for future iterations:**
  - LaunchMpv is in separate file mpv/launch.go (keeps concerns separated from client.go)
  - Uses deps.CheckMpv() to verify mpv is installed before launching
  - Returns *exec.Cmd which can be used to Wait() or Kill() the process later
  - Uses cmd.Start() (non-blocking) rather than cmd.Run() (blocking)
  - Socket path is shared via mpv.DefaultSocketPath constant

---

## 2026-01-26 - US-015
- What was implemented: Open command to launch video session
- Files changed: cmd/root.go
- **Learnings for future iterations:**
  - openCmd in cmd/root.go launches mpv and connects via IPC
  - Uses retry loop (50 attempts, 100ms each) to wait for socket to be ready
  - Displays duration in MM:SS format after connecting
  - Waits for mpv process to exit before returning

---

## 2026-01-26 - US-016
- What was implemented: Note CRUD - add and list commands
- Files changed: cmd/note.go (new)
- **Learnings for future iterations:**
  - Subcommands organized in separate files (cmd/note.go for note commands)
  - Use client.GetProperty("path") to get current video path from mpv
  - Use sql.NullString for nullable TEXT columns from database
  - tabwriter package provides clean table formatting with column alignment
  - Pattern: connect to mpv first, then open database, then perform operations

---

## 2026-01-26 - US-017
- What was implemented: Note CRUD - edit and delete commands
- Files changed: cmd/note.go
- **Learnings for future iterations:**
  - Use cmd.Flags().Changed("flagname") to check if a flag was explicitly set (vs just using default)
  - Dynamic SQL query building: collect fields and args in slices, then join for UPDATE
  - For edit commands: first check if the record exists with QueryRow before attempting update
  - Delete command shows record details before prompting for confirmation (better UX)
  - Use fmt.Scanln to read user confirmation input

---

## 2026-01-26 - US-018
- What was implemented: Note filtering capabilities for note list command
- Files changed: cmd/note.go
- **Learnings for future iterations:**
  - Use parseTimeToSeconds helper to parse MM:SS or raw seconds for time range filters
  - Dynamic SQL query building for filters: start with base query, append " AND field = ?" for each filter
  - Collect query args in []interface{} slice, append as filters are added
  - All filters combine with AND logic for narrowing results
  - fmt.Sscanf returns count of successfully scanned values - use this to detect format

---

## 2026-01-26 - US-019
- What was implemented: Note goto command to jump to a note's timestamp
- Files changed: cmd/note.go
- **Learnings for future iterations:**
  - Pattern for "goto" commands: fetch record from DB first, then connect to mpv and seek
  - Use client.Seek(timestamp) for absolute positioning (uses the existing mpv client method)
  - Display note details after seeking for better UX (confirms which note was jumped to)
  - Query note by ID and check for sql.ErrNoRows for "not found" error handling

---
## 2026-01-26 - US-020
- What was implemented: Clip commands - create and list
- Files changed: cmd/clip.go (new)
- **Learnings for future iterations:**
  - Clip commands follow same pattern as note commands (connect to mpv, get video path, use database)
  - Use sync.Mutex for thread-safe in-memory state storage (clip start timestamp)
  - clipStartState struct holds temporary clip start position until 'clip end' is called
  - Reuse parseTimeToSeconds and nullStringValue helpers from cmd/note.go
  - Validate that video hasn't changed between 'clip start' and 'clip end' calls
  - Validate start < end for clip timestamps

---
## 2026-01-26 - US-021
- What was implemented: Clip playback with A-B loop
- Files changed: cmd/clip.go
- **Learnings for future iterations:**
  - clip play command: fetches clip from DB, seeks to start, sets A-B loop with SetABLoop()
  - clip stop command: uses ClearABLoop() to stop looping
  - mpv client already had SetABLoop(start, end) and ClearABLoop() from US-012
  - Pattern: database lookup first, then mpv connection and operations

---
## 2026-01-26 - US-022
- What was implemented: Category commands - list, add, delete
- Files changed: cmd/category.go (new)
- **Learnings for future iterations:**
  - Category commands don't need mpv connection - they're pure database operations
  - Use isUniqueConstraintError helper to detect duplicate category errors (SQLite "UNIQUE constraint failed")
  - Categories table has UNIQUE constraint on name column from US-005 migration
  - Simple contains() helper used instead of importing strings package to minimize dependencies

---
## 2026-01-26 - US-023
- What was implemented: Tackle commands - add and list
- Files changed: cmd/tackle.go (new)
- **Learnings for future iterations:**
  - Tackle commands follow the same pattern as note/clip commands
  - Required flags are validated manually in RunE (cobra doesn't enforce required flags for non-positional args)
  - Use isValidOutcome helper to validate outcome against allowed values (missed, completed, possible, other)
  - Star field is INTEGER in SQLite (0/1) - convert from bool with if/else
  - Tackles table was already created in US-006 with CHECK constraint on outcome column

---
