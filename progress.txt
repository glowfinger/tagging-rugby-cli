## Codebase Patterns
- Use `CGO_ENABLED=0` for all Go build/vet commands (required for modernc.org/sqlite)
- Go binary is at `/home/node/go/bin/go` - use `export PATH="$PATH:/home/node/go/bin"` before Go commands
- Database connection uses modernc.org/sqlite (pure Go implementation, no CGO)
- Add new table migrations to the `migrate()` function in db/db.go - always use `CREATE TABLE IF NOT EXISTS`

---

## 2026-01-26 - US-001
- Initial project scaffolding with cobra CLI framework
- Created main.go and cmd/root.go with root and version commands
- Files changed: main.go, cmd/root.go, go.mod, go.sum
- **Learnings for future iterations:**
  - Typecheck with CGO_ENABLED=0 to avoid CGO issues
  - cobra CLI structure: main.go calls cmd.Execute(), cmd/root.go defines rootCmd

---

## 2026-01-26 - US-002
- What was implemented: SQLite database setup with Open function
- Files changed: db/db.go, go.mod, go.sum
- **Learnings for future iterations:**
  - Database file stored at ~/.local/share/tagging-rugby-cli/data.db
  - Uses modernc.org/sqlite for pure Go SQLite (no CGO required)
  - db.Open() creates parent directories automatically
  - Always verify connection with db.Ping() before returning

---

## 2026-01-26 - US-003
- What was implemented: Notes table migration with idempotent CREATE TABLE IF NOT EXISTS
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Migrations run automatically via migrate() helper in db.Open()
  - Add future table migrations to the migrate() function
  - Each table creation should use CREATE TABLE IF NOT EXISTS for idempotency

---

## 2026-01-26 - US-004
- What was implemented: Clips table migration for storing video segments
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Follow same pattern as notes table: add to migrate() function with CREATE TABLE IF NOT EXISTS
  - Clips table stores start_seconds and end_seconds (REAL) to define video segments

---

## 2026-01-26 - US-005
- What was implemented: Categories table migration with default category seeding
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Use `INSERT OR IGNORE INTO` for idempotent seeding of default values
  - Default categories: try, tackle, turnover, lineout, scrum, penalty, kick
  - Categories table has UNIQUE constraint on name column

---

## 2026-01-26 - US-006
- What was implemented: Tackles table migration for detailed tackle tracking
- Files changed: db/db.go
- **Learnings for future iterations:**
  - Use SQLite CHECK constraint for enum-like fields: `outcome TEXT CHECK(outcome IN ('missed', 'completed', 'possible', 'other'))`
  - Star field is INTEGER (0/1) since SQLite has no native boolean type

---

## 2026-01-26 - US-007
- What was implemented: mpv IPC client with Unix socket connection
- Files changed: mpv/client.go (new file)
- **Learnings for future iterations:**
  - mpv package provides Client struct with Connect() and Close() methods
  - Default socket path: /tmp/tagging-rugby-mpv.sock (defined as DefaultSocketPath constant)
  - Use sync.Mutex for thread-safe connection handling
  - Custom errors: ErrNotConnected, ErrSocketNotFound for clear error handling

---

## 2026-01-26 - US-008
- What was implemented: sendCommand method for mpv IPC JSON protocol
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - mpv IPC uses JSON with format: `{"command": [cmd, args...], "request_id": <id>}`
  - Responses include `data`, `error`, and `request_id` fields
  - Use request_id to match responses since mpv can send async events
  - Use bufio.Reader for efficient line-based reading (responses are newline-terminated)
  - Error field is "success" on success, otherwise contains error message
  - Use sync/atomic for thread-safe request ID generation

---

## 2026-01-26 - US-009
- What was implemented: Get/set property methods for mpv IPC client
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - Use `get_property` and `set_property` mpv commands for property access
  - mpv property names use hyphens (e.g., "time-pos", "ab-loop-a")
  - JSON unmarshals numbers as float64 - use helper function to handle type conversions
  - Boolean properties (like "pause") return Go bool type directly from JSON
  - Convenience methods (GetTimePos, GetDuration, GetPaused) wrap GetProperty for type safety

---

## 2026-01-26 - US-010
- What was implemented: Playback control methods for mpv IPC client
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - Use `seek` command with "absolute" or "relative" as second argument for seeking
  - Play/Pause simply set the "pause" property to false/true
  - TogglePause reads current state then inverts it
  - mpv seek command: `{"command": ["seek", <seconds>, "<mode>"]}`

---

## 2026-01-26 - US-011
- What was implemented: Advanced playback controls - speed, frame stepping, and mute
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - mpv `speed` property accepts float multipliers (1.0 = normal, 0.5 = half, 2.0 = double)
  - `frame-step` and `frame-back-step` are mpv commands (not properties) for single frame navigation
  - `mute` property is a boolean for audio muting
  - Boolean properties (pause, mute) return Go bool directly from JSON unmarshal

---

## 2026-01-26 - US-012
- What was implemented: A-B loop controls for clip playback
- Files changed: mpv/client.go
- **Learnings for future iterations:**
  - A-B loop uses `ab-loop-a` and `ab-loop-b` properties (hyphens, not underscores)
  - To clear the loop, set both properties to the string "no" (not a boolean or nil)
  - SetProperty accepts any interface{} so strings and floats both work

---

## 2026-01-26 - US-013
- What was implemented: Dependency checker with doctor command
- Files changed: deps/deps.go (new), cmd/root.go
- **Learnings for future iterations:**
  - Use `exec.LookPath` to check if a binary is available in PATH
  - deps package provides CheckMpv, CheckFfmpeg, and CheckAll functions
  - DependencyError type includes name and install URL for user-friendly messages
  - Doctor command exits with code 1 if any dependency is missing

---

## 2026-01-26 - US-014
- What was implemented: LaunchMpv function to start mpv with IPC socket
- Files changed: mpv/launch.go (new)
- **Learnings for future iterations:**
  - LaunchMpv is in separate file mpv/launch.go (keeps concerns separated from client.go)
  - Uses deps.CheckMpv() to verify mpv is installed before launching
  - Returns *exec.Cmd which can be used to Wait() or Kill() the process later
  - Uses cmd.Start() (non-blocking) rather than cmd.Run() (blocking)
  - Socket path is shared via mpv.DefaultSocketPath constant

---

## 2026-01-26 - US-015
- What was implemented: Open command to launch video session
- Files changed: cmd/root.go
- **Learnings for future iterations:**
  - openCmd in cmd/root.go launches mpv and connects via IPC
  - Uses retry loop (50 attempts, 100ms each) to wait for socket to be ready
  - Displays duration in MM:SS format after connecting
  - Waits for mpv process to exit before returning

---

## 2026-01-26 - US-016
- What was implemented: Note CRUD - add and list commands
- Files changed: cmd/note.go (new)
- **Learnings for future iterations:**
  - Subcommands organized in separate files (cmd/note.go for note commands)
  - Use client.GetProperty("path") to get current video path from mpv
  - Use sql.NullString for nullable TEXT columns from database
  - tabwriter package provides clean table formatting with column alignment
  - Pattern: connect to mpv first, then open database, then perform operations

---

## 2026-01-26 - US-017
- What was implemented: Note CRUD - edit and delete commands
- Files changed: cmd/note.go
- **Learnings for future iterations:**
  - Use cmd.Flags().Changed("flagname") to check if a flag was explicitly set (vs just using default)
  - Dynamic SQL query building: collect fields and args in slices, then join for UPDATE
  - For edit commands: first check if the record exists with QueryRow before attempting update
  - Delete command shows record details before prompting for confirmation (better UX)
  - Use fmt.Scanln to read user confirmation input

---

## 2026-01-26 - US-018
- What was implemented: Note filtering capabilities for note list command
- Files changed: cmd/note.go
- **Learnings for future iterations:**
  - Use parseTimeToSeconds helper to parse MM:SS or raw seconds for time range filters
  - Dynamic SQL query building for filters: start with base query, append " AND field = ?" for each filter
  - Collect query args in []interface{} slice, append as filters are added
  - All filters combine with AND logic for narrowing results
  - fmt.Sscanf returns count of successfully scanned values - use this to detect format

---

## 2026-01-26 - US-019
- What was implemented: Note goto command to jump to a note's timestamp
- Files changed: cmd/note.go
- **Learnings for future iterations:**
  - Pattern for "goto" commands: fetch record from DB first, then connect to mpv and seek
  - Use client.Seek(timestamp) for absolute positioning (uses the existing mpv client method)
  - Display note details after seeking for better UX (confirms which note was jumped to)
  - Query note by ID and check for sql.ErrNoRows for "not found" error handling

---
## 2026-01-26 - US-020
- What was implemented: Clip commands - create and list
- Files changed: cmd/clip.go (new)
- **Learnings for future iterations:**
  - Clip commands follow same pattern as note commands (connect to mpv, get video path, use database)
  - Use sync.Mutex for thread-safe in-memory state storage (clip start timestamp)
  - clipStartState struct holds temporary clip start position until 'clip end' is called
  - Reuse parseTimeToSeconds and nullStringValue helpers from cmd/note.go
  - Validate that video hasn't changed between 'clip start' and 'clip end' calls
  - Validate start < end for clip timestamps

---
## 2026-01-26 - US-021
- What was implemented: Clip playback with A-B loop
- Files changed: cmd/clip.go
- **Learnings for future iterations:**
  - clip play command: fetches clip from DB, seeks to start, sets A-B loop with SetABLoop()
  - clip stop command: uses ClearABLoop() to stop looping
  - mpv client already had SetABLoop(start, end) and ClearABLoop() from US-012
  - Pattern: database lookup first, then mpv connection and operations

---
## 2026-01-26 - US-022
- What was implemented: Category commands - list, add, delete
- Files changed: cmd/category.go (new)
- **Learnings for future iterations:**
  - Category commands don't need mpv connection - they're pure database operations
  - Use isUniqueConstraintError helper to detect duplicate category errors (SQLite "UNIQUE constraint failed")
  - Categories table has UNIQUE constraint on name column from US-005 migration
  - Simple contains() helper used instead of importing strings package to minimize dependencies

---
## 2026-01-26 - US-023
- What was implemented: Tackle commands - add and list
- Files changed: cmd/tackle.go (new)
- **Learnings for future iterations:**
  - Tackle commands follow the same pattern as note/clip commands
  - Required flags are validated manually in RunE (cobra doesn't enforce required flags for non-positional args)
  - Use isValidOutcome helper to validate outcome against allowed values (missed, completed, possible, other)
  - Star field is INTEGER in SQLite (0/1) - convert from bool with if/else
  - Tackles table was already created in US-006 with CHECK constraint on outcome column

---
## 2026-01-26 - US-024
- What was implemented: Tackle filtering for tackle list command
- Files changed: cmd/tackle.go
- **Learnings for future iterations:**
  - Follow same filtering pattern as note list (dynamic SQL query building with AND logic)
  - Use cmd.Flags().Changed("flag") to detect if boolean flag was explicitly set vs using default
  - Star filter only applies when explicitly set to true (--star flag present)
  - Reuse queryArgs slice pattern: start with base query, append " AND field = ?" for each filter

---
## 2026-01-26 - US-025
- What was implemented: Tackle export command to export player statistics to text file
- Files changed: cmd/tackle.go
- **Learnings for future iterations:**
  - Export commands don't require mpv connection - pure database operations
  - Use SQL CASE WHEN aggregations for counting by outcome type: `SUM(CASE WHEN outcome = 'completed' THEN 1 ELSE 0 END)`
  - File output uses os.Create and fmt.Fprintf for formatted text writing
  - Star symbol (â˜…) indicates starred tackles in export output
  - Pattern for exports: query counts first, then query details, write both to file

---
## 2026-01-26 - US-026
- What was implemented: Clip export command with ffmpeg integration
- Files changed: cmd/clip.go
- **Learnings for future iterations:**
  - Use deps.CheckFfmpeg() before running ffmpeg commands (returns error with install URL)
  - ffmpeg input seeking (-ss before -i) is faster than output seeking (-ss after -i)
  - When using input seeking with -ss, use -to with duration (end - start) rather than absolute end time
  - Stream copy (-c copy) is fast but may have keyframe issues; use --reencode for precision
  - buildFfmpegArgs helper pattern keeps ffmpeg command construction reusable
  - Use exec.Command with Stdout/Stderr set to os.Stdout/Stderr to show ffmpeg progress
  - filepath.Ext() to check if output path already has extension

---
## 2026-01-26 - US-027
- What was implemented: Bubbletea TUI app structure
- Files changed: tui/tui.go (new), cmd/root.go, go.mod, go.sum
- **Learnings for future iterations:**
  - Bubbletea uses tea.Model interface with Init(), Update(tea.Msg), View() methods
  - tea.NewProgram creates the program, p.Run() blocks until exit
  - tea.WithAltScreen() option uses alternate terminal screen (full-screen mode)
  - tea.Quit command returned from Update triggers graceful shutdown
  - tea.KeyMsg.String() returns key name for easy switch matching ("q", "ctrl+c", etc.)
  - Model struct holds all state: mpv client, database, video path
  - tui.Run() is the main entry point that creates Model and runs the program

---
## 2026-01-26 - US-028
- What was implemented: Lipgloss color palette and styles for TUI
- Files changed: tui/styles/styles.go (new)
- **Learnings for future iterations:**
  - Lipgloss styles package at tui/styles/styles.go provides reusable UI styles
  - Color constants defined as lipgloss.Color type (e.g., `DeepPurple = lipgloss.Color("#1a1a2e")`)
  - Pre-defined styles use lipgloss.NewStyle() with chained methods (.Background(), .Foreground(), .Bold(), etc.)
  - Available styles: Background, Panel, Border, Highlight, PrimaryText, SecondaryText, Warning, Success
  - Import with `"github.com/user/tagging-rugby-cli/tui/styles"` and use as `styles.Highlight`, etc.

---
## 2026-01-26 - US-029
- What was implemented: Status bar component for TUI with real-time mpv polling
- Files changed: tui/components/statusbar.go (new), tui/tui.go
- **Learnings for future iterations:**
  - TUI components go in tui/components/ directory (e.g., statusbar.go)
  - Use tea.Tick for polling - returns a Cmd that schedules a message after a duration
  - tickMsg pattern: define custom message type, create tickCmd() that returns tea.Tick, call tickCmd() from Init and after handling tick
  - StatusBarState struct holds all display state (Paused, Muted, TimePos, Duration, StepSize, OverlayEnabled)
  - Handle tea.WindowSizeMsg to get terminal dimensions for responsive layout
  - Use lipgloss.Width() to measure rendered string width (accounts for unicode/emoji)
  - Poll mpv silently by ignoring errors from Get* methods - display last known state on errors

---
## 2026-01-26 - US-030
- What was implemented: Notes list panel component for TUI
- Files changed: tui/components/noteslist.go (new), tui/tui.go
- **Learnings for future iterations:**
  - ListItem struct unifies notes and tackles for display in a single sorted list
  - ListItemType enum differentiates note vs tackle for badge rendering
  - NotesListState holds Items slice, SelectedIndex, and ScrollOffset for scrollable list
  - NotesList component calculates visible area and adjusts scroll offset to keep selection visible
  - loadNotesAndTackles in tui.go queries both notes and tackles tables, merges results, sorts by timestamp
  - For tackles, build display text from player + outcome + notes fields
  - Use sql.NullString for nullable TEXT columns, check .Valid before accessing .String
  - MoveUp/MoveDown/GetSelectedItem helper methods on NotesListState for list navigation (used in future stories)
  - Badge rendering uses different background colors (Cyan for notes, Pink for tackles) for visual distinction

---
## 2026-01-26 - US-031
- What was implemented: Command input component for TUI with command mode, parsing, and execution
- Files changed: tui/components/commandinput.go (new), tui/tui.go
- **Learnings for future iterations:**
  - CommandInputState struct holds Active, Input, CursorPos, Result, IsError fields
  - Use tea.KeyMsg.Type == tea.KeyRunes for handling typed characters (msg.Runes contains the runes)
  - For single printable chars, msg.String() returns the character as a string
  - clearResultMsg pattern: send a tea.Tick that returns clearResultMsg after a delay to auto-dismiss messages
  - Command parsing with strings.Fields splits command line into parts; first element is command, rest are args
  - Model now has clipStartTimestamp and clipStartSet for clip start/end workflow (not using global state)
  - parseTimeToSeconds and formatTimeString helpers added to tui/tui.go for time parsing and formatting
  - Commands implemented: note (add/list/goto), clip (start/end/list/play/stop), tackle (add/list), pause/play, mute, seek, speed, quit, help

---
## 2026-01-26 - US-032
- What was implemented: TUI keybindings for playback control
- Files changed: tui/tui.go
- **Learnings for future iterations:**
  - stepSizes package-level var defines the cycle values: 0.1, 0.5, 1, 2, 5, 10, 30 seconds
  - Space key triggers TogglePause via msg.String() == " " (single space)
  - Both lowercase and uppercase keys handled: "m", "M", "h", "H", "l", "L"
  - findStepSizeIndex helper finds current step size in array (with fallback for non-exact values)
  - decreaseStepSize/increaseStepSize cycle through stepSizes array with bounds checking
  - Check m.client != nil && m.client.IsConnected() before calling mpv methods

---
## 2026-01-26 - US-033
- What was implemented: TUI keybindings for list navigation (J/K to move selection, Enter to jump)
- Files changed: tui/tui.go
- **Learnings for future iterations:**
  - J moves selection up (previous item), K moves selection down (next item) - follows vim-like navigation
  - NotesListState already has MoveUp, MoveDown, GetSelectedItem helper methods from US-030
  - jumpToSelectedItem method seeks mpv and displays item details briefly using existing commandInput.SetResult pattern
  - Item details shown include type (note/tackle), ID, star symbol for starred items, and text/player/category info
  - Uses resultDisplayDuration (3 seconds) for auto-dismissing the jump message

---
## 2026-01-26 - US-034
- What was implemented: TUI help screen with keybindings overlay
- Files changed: tui/components/help.go (new), tui/tui.go
- **Learnings for future iterations:**
  - Help overlay is a full-screen replacement view (not a floating overlay on top of existing content)
  - showHelp boolean field in Model controls overlay visibility
  - Handle help dismissal BEFORE command mode check in Update - any key dismisses when help is shown
  - Keybindings grouped into struct slices for easy maintenance: Playback, Navigation, Views, Commands
  - Use lipgloss.Width() to calculate content dimensions for centering
  - Panel centering: calculate marginLeft = (width - panelWidth) / 2, marginTop = (height - panelHeight) / 2

---
## 2026-01-26 - US-035
- What was implemented: TUI stats view for tackle statistics
- Files changed: tui/components/statsview.go (new), tui/tui.go
- **Learnings for future iterations:**
  - Stats view follows same pattern as help overlay: boolean Active field in state struct, check before command mode in Update
  - StatsViewState holds Stats slice, SortColumn, AllVideos toggle, SelectedIndex, ScrollOffset
  - SortColumn enum with iota for type-safe column identification (0-6)
  - NextSortColumn method cycles with modulo: `(s.SortColumn + 1) % 7`
  - SQL aggregation pattern: `SUM(CASE WHEN outcome = 'completed' THEN 1 ELSE 0 END)`
  - Completion percentage: Completed / (Completed + Missed) * 100, only if denominator > 0
  - centerContent helper function reusable from help.go for consistent panel centering
  - Column highlighting in header uses Underline(true) style for current sort column

---

## 2026-01-26 - US-036
- What was implemented: TUI stats view player filtering with / key to enter filter mode, Enter to apply filter, Esc to clear filters
- Files changed: tui/components/statsview.go, tui/tui.go, tui/components/help.go, cmd/clip.go (go fmt)
- **Learnings for future iterations:**
  - Filter state uses map[string]bool for O(1) player lookup: FilteredPlayers map
  - ToggleFilter method handles both name substring matching and initials matching (e.g., "jd" matches "John Doe")
  - GetSortedStats returns stats with filtered players at top using append(filtered, nonFiltered...) pattern
  - Two-tier input handling: handleStatsViewInput checks FilterMode first, then delegates to handleStatsFilterInput
  - Filter display: Cyan foreground for filtered players, Purple (greyed out) for non-filtered when filters active
  - Helper matchesInitials uses strings.Builder to build initials from player name parts

---

## 2026-01-26 - US-037
- What was implemented: mpv overlay to display notes on video near current timestamp
- Files changed: mpv/client.go, tui/tui.go
- **Learnings for future iterations:**
  - mpv `osd-overlay` command format: `osd-overlay <id> <format> <data>` where format is "ass-events" for ASS styling or "none" to hide
  - ASS formatting uses backslash codes: `{\an7\pos(20,20)\fs24\1c&HFFFFFF&\3c&H201a1a&\bord3\shad0}` for positioning, alignment, font size, colors, border
  - ShowOverlay/HideOverlay methods added to mpv/client.go for reusable overlay control
  - Overlay updated during tick polling when overlayEnabled is true
  - Notes shown when within overlayProximitySeconds (2.0 seconds) of current timestamp
  - StatusBar.OverlayEnabled field tracks and displays overlay state with ðŸ“º icon

---

## 2026-01-26 - US-038
- What was implemented: Session resume - display existing notes/clips/tackles count when opening a video
- Files changed: cmd/root.go
- **Learnings for future iterations:**
  - Session data is detected by querying COUNT(*) on notes, clips, and tackles tables filtered by video_path
  - Database connection is opened early in openCmd to check for existing data, then reused for TUI mode
  - When totalItems > 0, display "Resuming session: X notes, Y clips, Z tackles" message
  - Database must be closed in CLI mode after counting (when not entering TUI mode)
  - Graceful handling when database fails to open - continue without session info

---
