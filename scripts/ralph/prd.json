{
  "project": "tagging-rugby-cli",
  "branchName": "ralph/improve-data-model",
  "description": "Replace flat data model with normalized schema - central notes table with child tables for videos, clips, timing, tackles, zones, details, and highlights",
  "userStories": [
    {
      "id": "US-047",
      "title": "Create new database schema with normalized tables",
      "description": "As a developer, I need the new normalized table structure so that all downstream features can build on it.",
      "acceptanceCriteria": [
        "Drop existing notes, clips, tackles, and categories tables in create_tables.sql",
        "Create notes table: id INTEGER PRIMARY KEY, category TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP",
        "Create note_videos table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, path TEXT, size INTEGER, duration REAL, format TEXT, stopped_at REAL",
        "Create note_clips table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, name TEXT, duration REAL, started_at DATETIME, finished_at DATETIME, error_at DATETIME, error TEXT",
        "Create note_timing table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, start REAL, end REAL",
        "Create note_tackles table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, player TEXT, attempt INTEGER, outcome TEXT",
        "Create note_zones table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, horizontal TEXT, vertical TEXT",
        "Create note_details table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, type TEXT, note TEXT",
        "Create note_highlights table: id INTEGER PRIMARY KEY, note_id INTEGER NOT NULL REFERENCES notes(id) ON DELETE CASCADE, type TEXT",
        "Create index on notes.category",
        "Create index on note_details.type",
        "Create index on note_highlights.type",
        "Enable PRAGMA foreign_keys = ON in db.Open() before running migrations",
        "Update migrate() function in db/db.go to use new create_tables.sql",
        "Remove seed_categories.sql and category seeding from migrate()",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented in commit cb4a1ae"
    },
    {
      "id": "US-048",
      "title": "Create SQL insert files for all child tables",
      "description": "As a developer, I need SQL insert files for each new child table so that the application can persist data.",
      "acceptanceCriteria": [
        "Create db/sql/insert_note.sql: INSERT INTO notes (category) VALUES (?) - returns id",
        "Create db/sql/insert_note_video.sql: INSERT INTO note_videos (note_id, path, size, duration, format, stopped_at) VALUES (?, ?, ?, ?, ?, ?)",
        "Create db/sql/insert_note_clip.sql: INSERT INTO note_clips (note_id, name, duration, started_at, finished_at, error_at, error) VALUES (?, ?, ?, ?, ?, ?, ?)",
        "Create db/sql/insert_note_timing.sql: INSERT INTO note_timing (note_id, start, end) VALUES (?, ?, ?)",
        "Create db/sql/insert_note_tackle.sql: INSERT INTO note_tackles (note_id, player, attempt, outcome) VALUES (?, ?, ?, ?)",
        "Create db/sql/insert_note_zone.sql: INSERT INTO note_zones (note_id, horizontal, vertical) VALUES (?, ?, ?)",
        "Create db/sql/insert_note_detail.sql: INSERT INTO note_details (note_id, type, note) VALUES (?, ?, ?)",
        "Create db/sql/insert_note_highlight.sql: INSERT INTO note_highlights (note_id, type) VALUES (?, ?)",
        "Remove old insert SQL files: insert_clip.sql, insert_clip_basic.sql, insert_tackle.sql, insert_tackle_basic.sql, insert_tackle_with_extras.sql, insert_category.sql, seed_categories.sql",
        "Update db/queries.go to embed all new insert SQL files and remove old ones",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented in commit 4aa7528"
    },
    {
      "id": "US-049",
      "title": "Create SQL select files for all child tables",
      "description": "As a developer, I need SQL select/query files for each new table so that the application can retrieve data.",
      "acceptanceCriteria": [
        "Create db/sql/select_notes.sql: SELECT id, category, created_at FROM notes ORDER BY created_at DESC",
        "Create db/sql/select_note_by_id.sql: SELECT id, category, created_at FROM notes WHERE id = ?",
        "Create db/sql/select_note_videos_by_note.sql: SELECT all columns FROM note_videos WHERE note_id = ?",
        "Create db/sql/select_note_clips_by_note.sql: SELECT all columns FROM note_clips WHERE note_id = ?",
        "Create db/sql/select_note_timing_by_note.sql: SELECT all columns FROM note_timing WHERE note_id = ?",
        "Create db/sql/select_note_tackles_by_note.sql: SELECT all columns FROM note_tackles WHERE note_id = ?",
        "Create db/sql/select_note_zones_by_note.sql: SELECT all columns FROM note_zones WHERE note_id = ?",
        "Create db/sql/select_note_details_by_note.sql: SELECT all columns FROM note_details WHERE note_id = ?",
        "Create db/sql/select_note_highlights_by_note.sql: SELECT all columns FROM note_highlights WHERE note_id = ?",
        "Create db/sql/delete_note.sql: DELETE FROM notes WHERE id = ? (cascade handles children)",
        "Remove old select SQL files that reference dropped tables",
        "Update db/queries.go to embed all new select SQL files and remove old ones",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-050",
      "title": "Create SQL queries for TUI list and stats views",
      "description": "As a developer, I need joined queries that pull data across the new tables for the TUI notes list and stats panel.",
      "acceptanceCriteria": [
        "Create db/sql/select_notes_with_timing.sql: JOIN notes with note_timing to get notes with start/end timestamps, ordered by start time",
        "Create db/sql/select_notes_with_video.sql: JOIN notes with note_videos to filter notes by video path",
        "Create db/sql/select_tackle_stats.sql: aggregate query on note_tackles for player stats (total, outcome counts)",
        "Remove all remaining old SQL files that reference dropped tables (count_clips_by_video.sql, count_notes_by_video.sql, count_tackles_by_video.sql, select_clip_export.sql, select_clip_play.sql, select_clips_by_video.sql, etc.)",
        "Update db/queries.go to embed new query files and remove all old references",
        "No references to old table names (clips, tackles, categories) remain in db/sql/ directory",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-051",
      "title": "Update Go structs and database functions for new schema",
      "description": "As a developer, I need Go structs and database helper functions updated to match the new table structure.",
      "acceptanceCriteria": [
        "Create Go structs: Note, NoteVideo, NoteClip, NoteTiming, NoteTackle, NoteZone, NoteDetail, NoteHighlight",
        "Create insert functions for each child table that accept struct or parameters and execute the embedded SQL",
        "Create InsertNoteWithChildren function that inserts a note and its related child records in a transaction",
        "Create select functions for querying each child table by note_id",
        "Create DeleteNote function that deletes by note id (cascade handles children)",
        "Remove old Go structs and functions that reference clips, tackles, categories tables",
        "All functions use the embedded SQL from db/queries.go",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-052",
      "title": "Update CLI commands for new data model",
      "description": "As a developer, I need CLI commands updated or removed to reflect the new schema.",
      "acceptanceCriteria": [
        "Remove cmd/category.go entirely",
        "Update cmd/note.go: note add creates a note row plus note_timing and note_videos child rows using current mpv state",
        "Update cmd/note.go: note list queries notes joined with note_timing for timestamp display",
        "Update cmd/note.go: note goto queries note_timing for seek position",
        "Update cmd/clip.go to create note + note_clips child rows instead of old clips table",
        "Update cmd/tackle.go to create note + note_tackles child rows instead of old tackles table",
        "Remove category subcommand registration from root command",
        "cmd/root.go open command session resume queries new tables for counts",
        "Application compiles and runs",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-053",
      "title": "Update TUI note and tackle creation for new data model",
      "description": "As a coach, I need TUI note and tackle input to write to the new normalized tables.",
      "acceptanceCriteria": [
        "Quick note input (N key) creates a note row plus note_timing and note_videos child rows",
        "Quick tackle input (T key) creates a note row plus note_tackles and note_timing child rows",
        "Command mode :nn creates note with child rows",
        "Command mode :nt creates tackle with child rows",
        "Command mode :cs/:ce creates note with note_clips child rows",
        "Confirmation messages display correctly after saving",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-054",
      "title": "Update TUI display views for new data model",
      "description": "As a coach, I need the TUI list, stats panel, and timeline to read from the new tables.",
      "acceptanceCriteria": [
        "Notes list (column 2) queries notes joined with note_timing for timestamps and note_details for display text",
        "Stats panel (column 3) queries note_tackles for player statistics",
        "Stats view (S key) queries note_tackles for full statistics with sort and filter",
        "Timeline progress bar queries note_timing for event marker positions",
        "mpv overlay queries note_timing and note_details for nearby notes display",
        "loadNotesAndTackles uses new joined queries to build ListItem slice",
        "Application compiles, runs, and displays correctly",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    }
  ]
}
